<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxH8gxO-udSGq71pi8M2Te6GSxz_QyNH5d9-Z9C1do-kUr5j14ukxrgneUIViMlg-vj/exec";

/* NAVBAR */
function toggleMenu() {
    document.querySelector(".nav-links").classList.toggle("show");
}

function loadNavbar() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    const nav = document.querySelector(".nav-links");

    if (user) {
        nav.innerHTML = `
            <a href="dashboard.html">Dashboard</a>
            <a href="communities.html">Communities</a>
            <a href="events.html">Events</a>
            <a href="profile.html">Profile</a>
            <a href="index.html" onclick="logout()">Logout</a>
        `;
    } else {
        window.location.href = "login.html";
    }
}

function logout() {
    localStorage.removeItem("contact_user");
    window.location.href = "index.html";
}

document.addEventListener("DOMContentLoaded", loadNavbar);

/* GLOBALS */
let activeConversationId = null;
let activeOtherUserId = null;

const user = JSON.parse(localStorage.getItem("contact_user"));
if (!user) window.location.href = "login.html";

/* LOAD CONVERSATIONS */
async function loadConversations() {
    const url = `${API_URL}?module=getConversations&userId=${encodeURIComponent(user.userId)}`;
    const res = await fetch(url);
    const conversations = await res.json();
    renderConversations(conversations);
}

function renderConversations(conversations) {
    const list = document.getElementById("conversationList");
    list.innerHTML = "";

    conversations.forEach(conv => {
        const div = document.createElement("div");
        div.className = "conversation";
        div.dataset.id = conv.conversationId;
        div.dataset.other = conv.otherUserId;

        div.innerHTML = `
            <strong>${conv.otherUserId}</strong><br>
            <small>${conv.lastMessage}</small>
        `;

        div.onclick = () => openChat(conv.conversationId, conv.otherUserId);
        list.appendChild(div);
    });
}

/* OPEN CHAT */
async function openChat(conversationId, otherUserId) {
    activeConversationId = conversationId;
    activeOtherUserId = otherUserId;

    document.querySelectorAll(".conversation").forEach(el => el.classList.remove("active"));
    event.target.closest(".conversation").classList.add("active");

    document.getElementById("chatHeader").textContent = otherUserId;

    const url = `${API_URL}?module=getMessages&conversationId=${encodeURIComponent(conversationId)}`;
    const res = await fetch(url);
    const messages = await res.json();

    renderMessages(messages);
}

function renderMessages(messages) {
    const chatBox = document.getElementById("chatMessages");
    chatBox.innerHTML = "";

    messages.forEach(msg => {
        const div = document.createElement("div");
        div.className = "message " + (msg.senderId === user.userId ? "sent" : "received");
        div.textContent = msg.message;
        chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
}

/* SEND MESSAGE */
async function sendMessage() {
    if (!activeConversationId) return;

    const input = document.getElementById("messageInput");
    const text = input.value.trim();
    if (!text) return;

    const url =
        `${API_URL}?module=sendMessage`
        + `&conversationId=${encodeURIComponent(activeConversationId)}`
        + `&senderId=${encodeURIComponent(user.userId)}`
        + `&receiverId=${encodeURIComponent(activeOtherUserId)}`
        + `&message=${encodeURIComponent(text)}`;

    await fetch(url);

    input.value = "";
    openChat(activeConversationId, activeOtherUserId);
}

document.addEventListener("DOMContentLoaded", loadConversations);
</script>
