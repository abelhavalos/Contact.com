<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/profile.css" />
    <title>Contact.com – Profile</title>
</head>

<body>

<nav class="navbar">
    <div class="logo">Contact<span>.</span>com</div>

    <div class="hamburger" onclick="toggleMenu()">
        <span></span><span></span><span></span>
    </div>

    <div class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="communities.html">Communities</a>
        <a href="events.html">Events</a>
        <a href="profile.html">Profile</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<!-- HERO -->
<div class="hero">
    <img id="profilePic" class="profile-pic" src="https://via.placeholder.com/150" />
    <input type="file" id="profilePicUpload" accept="image/*" style="display:none;" />

    <h1 id="fullNameDisplay">Your Name</h1>
    <p id="professionDisplay">Your profession or tagline</p>
</div>

<!-- EDITABLE SECTIONS -->
<div class="section">
    <h2>Full Name</h2>
    <input id="fullName" disabled />
</div>

<div class="section">
    <h2>Profession</h2>
    <input id="profession" disabled />
</div>

<div class="section">
    <h2>About Me</h2>
    <textarea id="about" rows="5" disabled></textarea>
</div>

<div class="section">
    <h2>Skills</h2>
    <input id="skills" disabled />
</div>

<div class="section">
    <h2>Work & Life</h2>
    <textarea id="workLife" rows="5" disabled></textarea>
</div>

<!-- CHANGE EMAIL -->
<div class="section">
    <h2>Change Email</h2>
    <input id="newEmail" type="email" placeholder="Enter new email" />
    <button onclick="changeEmail()">Update Email</button>
</div>

<!-- CHANGE PASSWORD -->
<div class="section">
    <h2>Change Password</h2>
    <input id="newPassword" type="password" placeholder="New password" />
    <input id="confirmPassword" type="password" placeholder="Confirm password" style="margin-top:10px;" />
    <button onclick="changePassword()">Update Password</button>
</div>

<!-- GALLERY -->
<div class="section">
    <h2>Photos & Videos</h2>

    <input type="file" id="mediaUpload" accept="image/*,video/*" multiple style="display:none;" />
    <button onclick="document.getElementById('mediaUpload').click()">Upload Media</button>

    <div class="gallery" id="gallery"></div>
</div>

<!-- ACTION BUTTONS -->
<div class="section" style="text-align:center;">
    <button class="edit-btn" id="editBtn" onclick="enableEditing()">Edit Profile</button>
    <button id="saveBtn" onclick="saveProfile()" style="display:none;">Save Changes</button>
</div>

<script>
/* ⭐ IMPORTANT: PUT YOUR REAL WEB APP URL HERE */
const API_URL = "https://script.google.com/macros/s/AKfycbx-Jgk4sWWdUjfr8z5RBRrTmGjNSkpuf-vsQqTnK_XJbCLkwSbMptwfdc7G11Zypeob/exec";

/* NAV MENU */
function toggleMenu() {
    document.querySelector('.nav-links').classList.toggle('show');
}

/* LOAD PROFILE */
document.addEventListener("DOMContentLoaded", loadProfile);

function loadProfile() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    if (!user) return window.location.href = "login.html";

    document.getElementById("fullNameDisplay").innerText = user.fullName;
    document.getElementById("professionDisplay").innerText = user.profession || "Your profession";

    document.getElementById("fullName").value = user.fullName;
    document.getElementById("profession").value = user.profession || "";
    document.getElementById("about").value = user.about || "";
    document.getElementById("skills").value = user.skills || "";
    document.getElementById("workLife").value = user.workLife || "";

    if (user.profilePic) {
        document.getElementById("profilePic").src = user.profilePic;
    }

    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";

    if (user.gallery) {
        user.gallery.forEach(item => {
            const el = item.type === "video"
                ? document.createElement("video")
                : document.createElement("img");

            el.src = item.url;
            if (item.type === "video") el.controls = true;

            gallery.appendChild(el);
        });
    }
}

/* ENABLE EDITING */
function enableEditing() {
    document.querySelectorAll("#fullName, #profession, #about, #skills, #workLife")
        .forEach(el => el.disabled = false);

    document.getElementById("saveBtn").style.display = "inline-block";
    document.getElementById("editBtn").style.display = "none";
}
/* PROFILE PIC UPLOAD */
document.getElementById("profilePic").addEventListener("click", () => {
    document.getElementById("profilePicUpload").click();
});

document.getElementById("profilePicUpload").addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const url = URL.createObjectURL(file);

    document.getElementById("profilePic").src = url;

    const user = JSON.parse(localStorage.getItem("contact_user"));
    user.profilePic = url;
    localStorage.setItem("contact_user", JSON.stringify(user));
});

/* GALLERY UPLOAD */
document.getElementById("mediaUpload").addEventListener("change", function(event) {
    const files = Array.from(event.target.files);
    const user = JSON.parse(localStorage.getItem("contact_user"));

    if (!user.gallery) user.gallery = [];

    files.forEach(file => {
        const url = URL.createObjectURL(file);
        const type = file.type.startsWith("video") ? "video" : "image";

        user.gallery.push({ url, type });
    });

    localStorage.setItem("contact_user", JSON.stringify(user));
    loadProfile();
});

/* SAVE PROFILE TO BACKEND */
async function saveProfile() {
    const user = JSON.parse(localStorage.getItem("contact_user"));

    const fullName = document.getElementById("fullName").value;
    const profession = document.getElementById("profession").value;
    const about = document.getElementById("about").value;
    const skills = document.getElementById("skills").value;
    const workLife = document.getElementById("workLife").value;

    const url = `${API_URL}?module=saveProfile`
        + `&email=${encodeURIComponent(user.email)}`
        + `&fullName=${encodeURIComponent(fullName)}`
        + `&profession=${encodeURIComponent(profession)}`
        + `&about=${encodeURIComponent(about)}`
        + `&skills=${encodeURIComponent(skills)}`
        + `&workLife=${encodeURIComponent(workLife)}`;

    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        user.fullName = fullName;
        user.profession = profession;
        user.about = about;
        user.skills = skills;
        user.workLife = workLife;

        localStorage.setItem("contact_user", JSON.stringify(user));

        alert("Profile updated!");
        window.location.reload();
    } else {
        alert(result.message || "Failed to update profile.");
    }
}

/* CHANGE EMAIL */
async function changeEmail() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    const newEmail = document.getElementById("newEmail").value.trim();

    if (!newEmail.includes("@")) {
        alert("Enter a valid email.");
        return;
    }

    const url = `${API_URL}?module=changeEmail&oldEmail=${encodeURIComponent(user.email)}&newEmail=${encodeURIComponent(newEmail)}`;
    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        localStorage.setItem("contact_user", JSON.stringify(result.user));
        alert("Email updated!");
        window.location.reload();
    } else {
        alert(result.message || "Failed to update email.");
    }
}

/* CHANGE PASSWORD */
async function changePassword() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    const newPass = document.getElementById("newPassword").value;
    const confirmPass = document.getElementById("confirmPassword").value;

    if (newPass.length < 6) {
        alert("Password must be at least 6 characters.");
        return;
    }

    if (newPass !== confirmPass) {
        alert("Passwords do not match.");
        return;
    }

    const url = `${API_URL}?module=changePassword&email=${encodeURIComponent(user.email)}&newPassword=${encodeURIComponent(newPass)}`;
    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        alert("Password updated!");
        localStorage.removeItem("contact_user");
        window.location.href = "login.html";
    } else {
        alert(result.message || "Failed to update password.");
    }
}

/* LOGOUT */
function logout() {
    localStorage.removeItem("contact_user");
    window.location.href = "index.html";
}
</script>

</body>
</html>
