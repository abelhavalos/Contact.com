<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/profile.css" />
    <title>Contact.com – Profile</title>
</head>

<body>

<nav class="navbar">
    <div class="logo">Contact<span>.</span>com</div>

    <div class="hamburger" onclick="toggleMenu()">
        <span></span><span></span><span></span>
    </div>

    <div class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="communities.html">Communities</a>
        <a href="events.html">Events</a>
        <a href="profile.html">Profile</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<!-- HERO -->
<!-- HERO -->
<div class="hero">
    <img id="profilePic" class="profile-pic" src="https://via.placeholder.com/150" />

    <h1 id="fullNameDisplay">Your Name</h1>
    <p id="professionDisplay">Your profession or tagline</p>

    <!-- PROFILE PIC UPLOAD -->
    <div class="profile-upload-box">
        <button onclick="document.getElementById('profilePicFile').click()">Choose Photo</button>

        <!-- Hidden form that POSTS directly to Apps Script -->
        <form id="profilePicForm"
              action="https://script.google.com/macros/s/AKfycbx-Jgk4sWWdUjfr8z5RBRrTmGjNSkpuf-vsQqTnK_XJbCLkwSbMptwfdc7G11Zypeob/exec"
              method="POST"
              enctype="multipart/form-data"
              target="uploadFrame">
            <input type="hidden" name="module" value="uploadProfilePic" />
            <input type="hidden" name="email" id="uploadEmail" />
            <input type="file" name="file" id="profilePicFile" accept="image/*" style="display:none;" />
        </form>

        <!-- Hidden iframe to receive the upload response -->
        <iframe name="uploadFrame" style="display:none;"></iframe>
    </div>
</div>

<!-- EDITABLE SECTIONS -->
<div class="section">
    <h2>Full Name</h2>
    <input id="fullName" disabled />
</div>

<div class="section">
    <h2>Profession</h2>
    <input id="profession" disabled />
</div>

<div class="section">
    <h2>About Me</h2>
    <textarea id="about" rows="5" disabled></textarea>
</div>

<div class="section">
    <h2>Skills</h2>
    <input id="skills" disabled />
</div>

<div class="section">
    <h2>Work & Life</h2>
    <textarea id="workLife" rows="5" disabled></textarea>
</div>

<!-- PROFILE PIC VIA GOOGLE DRIVE -->
<div class="section">
    <h2>Profile Picture (Google Drive Link)</h2>
    <input id="profilePicLink" placeholder="Paste Google Drive link" />
    <button onclick="applyProfilePicLink()">Use Link</button>
</div>

<!-- GALLERY VIA GOOGLE DRIVE -->
<div class="section">
    <h2>Photos & Videos (Google Drive Links)</h2>

    <input id="galleryLink" placeholder="Paste Google Drive link" />
    <button onclick="addGalleryItem()">Add to Gallery</button>

    <div class="gallery" id="gallery"></div>
</div>

<!-- CHANGE EMAIL -->
<div class="section">
    <h2>Change Email</h2>
    <input id="newEmail" type="email" placeholder="Enter new email" />
    <button onclick="changeEmail()">Update Email</button>
</div>

<!-- CHANGE PASSWORD -->
<div class="section">
    <h2>Change Password</h2>
    <input id="newPassword" type="password" placeholder="New password" />
    <input id="confirmPassword" type="password" placeholder="Confirm password" style="margin-top:10px;" />
    <button onclick="changePassword()">Update Password</button>
</div>

<!-- ACTION BUTTONS -->
<div class="section" style="text-align:center;">
    <button class="edit-btn" id="editBtn" onclick="enableEditing()">Edit Profile</button>
    <button id="saveBtn" onclick="saveProfile()" style="display:none;">Save Changes</button>
</div>

<script>
/* REAL WEB APP URL */
const API_URL = "https://script.google.com/macros/s/AKfycbx-Jgk4sWWdUjfr8z5RBRrTmGjNSkpuf-vsQqTnK_XJbCLkwSbMptwfdc7G11Zypeob/exec";

/* NAV MENU */
function toggleMenu() {
    document.querySelector('.nav-links').classList.toggle('show');
}

/* LOAD PROFILE */
document.addEventListener("DOMContentLoaded", loadProfile);

function loadProfile() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    if (!user) return window.location.href = "login.html";

    document.getElementById("fullNameDisplay").innerText = user.fullName;
    document.getElementById("professionDisplay").innerText = user.profession || "Your profession";

    document.getElementById("fullName").value = user.fullName;
    document.getElementById("profession").value = user.profession || "";
    document.getElementById("about").value = user.about || "";
    document.getElementById("skills").value = user.skills || "";
    document.getElementById("workLife").value = user.workLife || "";

    if (user.profilePic) {
        document.getElementById("profilePic").src = user.profilePic;
    }

    if (!user.gallery) user.gallery = [];
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";
    user.gallery.forEach(item => {
        let el = item.type === "video" ? document.createElement("video") : document.createElement("img");
        if (item.type === "video") el.controls = true;
        el.src = item.url;
        gallery.appendChild(el);
    });

    document.getElementById("uploadEmail").value = user.email;
}

/* PROFILE PIC FILE CHANGE → SUBMIT FORM */
document.getElementById("profilePicFile").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (!file) return;

    document.getElementById("profilePicForm").submit();
    alert("Uploading profile picture...");
});

/* RECEIVE MESSAGE FROM APPS SCRIPT (via iframe) */
window.addEventListener("message", function (event) {
    const data = event.data;
    if (!data || data.type !== "profilePicUploaded") return;

    if (data.error) {
        alert("Upload failed: " + data.error);
        return;
    }

    const url = data.url;
    const user = JSON.parse(localStorage.getItem("contact_user"));

    user.profilePic = url;
    localStorage.setItem("contact_user", JSON.stringify(user));

    document.getElementById("profilePic").src = url;
    alert("Profile picture updated!");
});

/* ENABLE EDITING */
function enableEditing() {
    document.querySelectorAll("#fullName, #profession, #about, #skills, #workLife")
        .forEach(el => el.disabled = false);

    document.getElementById("saveBtn").style.display = "inline-block";
    document.getElementById("editBtn").style.display = "none";
}

/* PROFILE PIC FROM DRIVE LINK */
function applyProfilePicLink() {
    const link = document.getElementById("profilePicLink").value.trim();
    const fileId = extractDriveId(link);
    if (!fileId) return alert("Invalid Google Drive link");

    const direct = `https://drive.google.com/uc?export=view&id=${fileId}`;

    const user = JSON.parse(localStorage.getItem("contact_user"));
    user.profilePic = direct;
    localStorage.setItem("contact_user", JSON.stringify(user));

    document.getElementById("profilePic").src = direct;
}

/* ADD GALLERY ITEM FROM DRIVE LINK */
function addGalleryItem() {
    const link = document.getElementById("galleryLink").value.trim();
    const fileId = extractDriveId(link);
    if (!fileId) return alert("Invalid Google Drive link");

    const direct = `https://drive.google.com/uc?export=view&id=${fileId}`;
    const type = link.includes("video") ? "video" : "image";

    const user = JSON.parse(localStorage.getItem("contact_user"));
    if (!user.gallery) user.gallery = [];

    user.gallery.push({ url: direct, type });
    localStorage.setItem("contact_user", JSON.stringify(user));

    loadProfile();
}

/* EXTRACT DRIVE FILE ID */
function extractDriveId(url) {
    const match = url.match(/\/d\/(.*?)\//);
    return match ? match[1] : null;
}

/* SAVE PROFILE (GET ONLY) */
async function saveProfile() {
    const user = JSON.parse(localStorage.getItem("contact_user"));

    const url = `${API_URL}?module=saveProfile`
        + `&email=${encodeURIComponent(user.email)}`
        + `&fullName=${encodeURIComponent(document.getElementById("fullName").value)}`
        + `&profession=${encodeURIComponent(document.getElementById("profession").value)}`
        + `&about=${encodeURIComponent(document.getElementById("about").value)}`
        + `&skills=${encodeURIComponent(document.getElementById("skills").value)}`
        + `&workLife=${encodeURIComponent(document.getElementById("workLife").value)}`
        + `&profilePic=${encodeURIComponent(user.profilePic || "")}`
        + `&gallery=${encodeURIComponent(JSON.stringify(user.gallery || []))}`;

    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        localStorage.setItem("contact_user", JSON.stringify(result.user));
        alert("Profile updated");
        window.location.reload();
    } else {
        alert(result.message || "Failed to update profile");
    }
}

/* CHANGE EMAIL */
async function changeEmail() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    const newEmail = document.getElementById("newEmail").value.trim();

    const url = `${API_URL}?module=changeEmail&oldEmail=${encodeURIComponent(user.email)}&newEmail=${encodeURIComponent(newEmail)}`;
    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        localStorage.setItem("contact_user", JSON.stringify(result.user));
        alert("Email updated");
        window.location.reload();
    } else {
        alert(result.message || "Failed to update email");
    }
}

/* CHANGE PASSWORD */
async function changePassword() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    const newPass = document.getElementById("newPassword").value;
    const confirmPass = document.getElementById("confirmPassword").value;

    if (newPass !== confirmPass) return alert("Passwords do not match");

    const url = `${API_URL}?module=changePassword&email=${encodeURIComponent(user.email)}&newPassword=${encodeURIComponent(newPass)}`;
    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        alert("Password updated");
        localStorage.removeItem("contact_user");
        window.location.href = "login.html";
    } else {
        alert(result.message || "Failed to update password");
    }
}

/* LOGOUT */
function logout() {
    localStorage.removeItem("contact_user");
    window.location.href = "index.html";
}
</script>

</body>
</html>