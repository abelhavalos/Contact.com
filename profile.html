<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles/profile.css" />
    <title>Contact.com – Profile</title>
</head>

<body>

<nav class="navbar">
    <div class="logo">Contact<span>.</span>com</div>

    <div class="hamburger" onclick="toggleMenu()">
        <span></span><span></span><span></span>
    </div>

    <div class="nav-links">
        <a href="dashboard.html">Dashboard</a>
        <a href="communities.html">Communities</a>
        <a href="events.html">Events</a>
        <a href="profile.html">Profile</a>
        <a href="#" onclick="logout()">Logout</a>
    </div>
</nav>

<!-- HERO -->
<!-- HERO -->
<div class="hero">
    <img id="profilePic" class="profile-pic" src="https://via.placeholder.com/150" />

    <h1 id="fullNameDisplay">Your Name</h1>
    <p id="professionDisplay">Your profession or tagline</p>

    <!-- PROFILE PIC UPLOAD -->
    <div class="profile-upload-box">
        <button onclick="document.getElementById('profilePicFile').click()">Choose Photo</button>

        <!-- Hidden form that POSTS directly to Apps Script -->
        <form id="profilePicForm"
              action="https://script.google.com/macros/s/AKfycbx-Jgk4sWWdUjfr8z5RBRrTmGjNSkpuf-vsQqTnK_XJbCLkwSbMptwfdc7G11Zypeob/exec"
              method="POST"
              enctype="multipart/form-data"
              target="uploadFrame">
            <input type="hidden" name="module" value="uploadProfilePic" />
            <input type="hidden" name="email" id="uploadEmail" />
            <input type="file" name="file" id="profilePicFile" accept="image/*" style="display:none;" />
        </form>

        <!-- Hidden iframe to receive the upload response -->
        <iframe name="uploadFrame" style="display:none;"></iframe>
    </div>
</div>

<!-- EDITABLE SECTIONS -->
<div class="section">
    <h2>Full Name</h2>
    <input id="fullName" disabled />
</div>

<div class="section">
    <h2>Profession</h2>
    <input id="profession" disabled />
</div>

<div class="section">
    <h2>About Me</h2>
    <textarea id="about" rows="5" disabled></textarea>
</div>

<div class="section">
    <h2>Skills</h2>
    <input id="skills" disabled />
</div>

<div class="section">
    <h2>Work & Life</h2>
    <textarea id="workLife" rows="5" disabled></textarea>
</div>

<!-- PROFILE PIC VIA GOOGLE DRIVE -->
<div class="section">
    <h2>Profile Picture (Google Drive Link)</h2>
    <input id="profilePicLink" placeholder="Paste Google Drive link" />
    <button onclick="applyProfilePicLink()">Use Link</button>
</div>

<!-- GALLERY VIA GOOGLE DRIVE -->
<div class="section">
    <h2>Photos & Videos (Google Drive Links)</h2>

    <input id="galleryLink" placeholder="Paste Google Drive link" />
    <button onclick="addGalleryItem()">Add to Gallery</button>

    <div class="gallery" id="gallery"></div>
</div>

<!-- CHANGE EMAIL -->
<div class="section">
    <h2>Change Email</h2>
    <input id="newEmail" type="email" placeholder="Enter new email" />
    <button onclick="changeEmail()">Update Email</button>
</div>

<!-- CHANGE PASSWORD -->
<div class="section">
    <h2>Change Password</h2>
    <input id="newPassword" type="password" placeholder="New password" />
    <input id="confirmPassword" type="password" placeholder="Confirm password" style="margin-top:10px;" />
    <button onclick="changePassword()">Update Password</button>
</div>

<!-- ACTION BUTTONS -->
<div class="section" style="text-align:center;">
    <button class="edit-btn" id="editBtn" onclick="enableEditing()">Edit Profile</button>
    <button id="saveBtn" onclick="saveProfile()" style="display:none;">Save Changes</button>
</div>

<script>
/* REAL WEB APP URL */
const API_URL = "https://script.google.com/macros/s/AKfycbx-Jgk4sWWdUjfr8z5RBRrTmGjNSkpuf-vsQqTnK_XJbCLkwSbMptwfdc7G11Zypeob/exec";

/* NAV MENU */
function toggleMenu() {
    document.querySelector('.nav-links').classList.toggle('show');
}

/* LOAD PROFILE */
document.addEventListener("DOMContentLoaded", loadProfile);

function loadProfile() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    if (!user) return window.location.href = "login.html";

    // Safe DOM access
    setValue("fullNameDisplay", user.fullName);
    setValue("professionDisplay", user.profession || "Your profession");

    setInput("fullName", user.fullName);
    setInput("profession", user.profession);
    setInput("about", user.about);
    setInput("skills", user.skills);
    setInput("workLife", user.workLife);

    if (user.profilePic) {
        setSrc("profilePic", user.profilePic);
    }

    // Gallery
    if (!Array.isArray(user.gallery)) user.gallery = [];
    const gallery = document.getElementById("gallery");
    gallery.innerHTML = "";

    user.gallery.forEach(item => {
        const el = item.type === "video" ? document.createElement("video") : document.createElement("img");
        if (item.type === "video") el.controls = true;
        el.src = item.url;
        gallery.appendChild(el);
    });

    setInput("uploadEmail", user.email);
}

/* SAFE HELPERS */
function setValue(id, value) {
    const el = document.getElementById(id);
    if (el) el.innerText = value;
}

function setInput(id, value) {
    const el = document.getElementById(id);
    if (el) el.value = value || "";
}

function setSrc(id, value) {
    const el = document.getElementById(id);
    if (el) el.src = value;
}

/* PROFILE PIC FILE CHANGE → SUBMIT FORM */
const picFile = document.getElementById("profilePicFile");
if (picFile) {
    picFile.addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;

        const form = document.getElementById("profilePicForm");
        if (form) form.submit();

        alert("Uploading profile picture...");
    });
}

/* RECEIVE MESSAGE FROM APPS SCRIPT (via iframe) */
window.addEventListener("message", function (event) {
    const data = event.data;
    if (!data || data.type !== "profilePicUploaded") return;

    if (data.error) {
        alert("Upload failed: " + data.error);
        return;
    }

    const user = JSON.parse(localStorage.getItem("contact_user"));
    user.profilePic = data.url;

    localStorage.setItem("contact_user", JSON.stringify(user));
    setSrc("profilePic", data.url);

    alert("Profile picture updated!");
});

/* ENABLE EDITING */
function enableEditing() {
    document.querySelectorAll("#fullName, #profession, #about, #skills, #workLife")
        .forEach(el => el.disabled = false);

    setDisplay("saveBtn", "inline-block");
    setDisplay("editBtn", "none");
}

function setDisplay(id, value) {
    const el = document.getElementById(id);
    if (el) el.style.display = value;
}

/* PROFILE PIC FROM DRIVE LINK */
function applyProfilePicLink() {
    const link = document.getElementById("profilePicLink").value.trim();
    const fileId = extractDriveId(link);
    if (!fileId) return alert("Invalid Google Drive link");

    const direct = `https://drive.google.com/uc?export=view&id=${fileId}`;

    const user = JSON.parse(localStorage.getItem("contact_user"));
    user.profilePic = direct;

    localStorage.setItem("contact_user", JSON.stringify(user));
    setSrc("profilePic", direct);
}

/* ADD GALLERY ITEM FROM DRIVE LINK */
function addGalleryItem() {
    const link = document.getElementById("galleryLink").value.trim();
    const fileId = extractDriveId(link);
    if (!fileId) return alert("Invalid Google Drive link");

    const direct = `https://drive.google.com/uc?export=view&id=${fileId}`;
    const type = link.includes("video") ? "video" : "image";

    const user = JSON.parse(localStorage.getItem("contact_user"));
    if (!Array.isArray(user.gallery)) user.gallery = [];

    user.gallery.push({ url: direct, type });
    localStorage.setItem("contact_user", JSON.stringify(user));

    loadProfile();
}

/* EXTRACT DRIVE FILE ID */
function extractDriveId(url) {
    const match = url.match(/\/d\/(.*?)\//);
    return match ? match[1] : null;
}

/* SAVE PROFILE (GET ONLY) */
async function saveProfile() {
    const user = JSON.parse(localStorage.getItem("contact_user"));

    const url =
        `${API_URL}?module=saveProfile`
        + `&email=${encodeURIComponent(user.email)}`
        + `&fullName=${encodeURIComponent(getVal("fullName"))}`
        + `&profession=${encodeURIComponent(getVal("profession"))}`
        + `&about=${encodeURIComponent(getVal("about"))}`
        + `&skills=${encodeURIComponent(getVal("skills"))}`
        + `&workLife=${encodeURIComponent(getVal("workLife"))}`
        + `&profilePic=${encodeURIComponent(user.profilePic || "")}`
        + `&gallery=${encodeURIComponent(JSON.stringify(user.gallery || []))}`;

    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        localStorage.setItem("contact_user", JSON.stringify(result.user));
        alert("Profile updated");
        window.location.reload();
    } else {
        alert(result.message || "Failed to update profile");
    }
}

function getVal(id) {
    const el = document.getElementById(id);
    return el ? el.value : "";
}

/* CHANGE EMAIL */
async function changeEmail() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    const newEmail = getVal("newEmail").trim();

    const url = `${API_URL}?module=changeEmail&oldEmail=${encodeURIComponent(user.email)}&newEmail=${encodeURIComponent(newEmail)}`;
    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        localStorage.setItem("contact_user", JSON.stringify(result.user));
        alert("Email updated");
        window.location.reload();
    } else {
        alert(result.message || "Failed to update email");
    }
}

/* CHANGE PASSWORD */
async function changePassword() {
    const user = JSON.parse(localStorage.getItem("contact_user"));
    const newPass = getVal("newPassword");
    const confirmPass = getVal("confirmPassword");

    if (newPass !== confirmPass) return alert("Passwords do not match");

    const url = `${API_URL}?module=changePassword&email=${encodeURIComponent(user.email)}&newPassword=${encodeURIComponent(newPass)}`;
    const res = await fetch(url);
    const result = await res.json();

    if (result.success) {
        alert("Password updated");
        localStorage.removeItem("contact_user");
        window.location.href = "login.html";
    } else {
        alert(result.message || "Failed to update password");
    }
}

/* LOGOUT */
function logout() {
    localStorage.removeItem("contact_user");
    window.location.href = "index.html";
}
</script>
</body>
</html>
